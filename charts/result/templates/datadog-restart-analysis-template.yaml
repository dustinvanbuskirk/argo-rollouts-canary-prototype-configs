apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: {{ include "result.fullname" . }}-datadog-404
  labels:
    {{- include "result.labels" . | nindent 4 }}
spec:
  args:
  - name: service-name
    value: {{ include "result.fullname" . }}-preview
  - name: namespace
    value: {{ .Release.Namespace }}
  - name: app-name
    value: {{ include "result.name" . }}
  metrics:
  - name: canary-pod-restarts
    initialDelay: 30s
    interval: 1m
    count: 3
    # Success if restart count is 0 or doesn't increase
    successCondition: result <= 0
    failureLimit: 2
    provider:
      datadog:
        apiVersion: v2
        interval: 5m
        query: |
          sum:kubernetes.containers.restarts{kube_namespace:{{`{{args.namespace}}`}},kube_deployment:{{`{{args.service-name}}`}},app:{{`{{args.app-name}}`}}}.as_count()
  
  - name: canary-pod-crash-loop
    initialDelay: 30s
    interval: 1m
    count: 3
    # Success if no crash looping pods
    successCondition: result == 0
    failureLimit: 1
    provider:
      datadog:
        apiVersion: v2
        interval: 5m
        query: |
          sum:kubernetes.pods.crash_looping{kube_namespace:{{`{{args.namespace}}`}},kube_deployment:{{`{{args.service-name}}`}},app:{{`{{args.app-name}}`}}}
  
  - name: canary-pod-oomkilled
    initialDelay: 30s
    interval: 1m
    count: 3
    # Success if no OOMKilled containers
    successCondition: result == 0
    failureLimit: 1
    provider:
      datadog:
        apiVersion: v2
        interval: 5m
        query: |
          sum:kubernetes.containers.state.oomkilled{kube_namespace:{{`{{args.namespace}}`}},kube_deployment:{{`{{args.service-name}}`}},app:{{`{{args.app-name}}`}}}